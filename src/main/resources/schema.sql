--/**
-- * @author Somendra Datta <sodatta@gmail.com>
-- * @version 12/07/25
-- */


-- New table for TeamEntity
CREATE TABLE IF NOT EXISTS DL_TEAM (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL UNIQUE,
    DESCRIPTION TEXT,
    ROLE VARCHAR(50) NOT NULL
);

-- New table for StoreEntity
CREATE TABLE IF NOT EXISTS DL_STORE (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL,
    ADDRESS VARCHAR(255),
    CONTACT_NUMBER VARCHAR(20),
    EMAIL VARCHAR(255),
    MANAGER_ID BIGINT
);


-- New table for ManagerEntity
CREATE TABLE IF NOT EXISTS DL_MANAGER (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL,
    CONTACT VARCHAR(255) NOT NULL
);

-- New table for CustomerEntity
CREATE TABLE IF NOT EXISTS DL_CUSTOMER (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SUBSCRIBER_ID VARCHAR(255) UNIQUE,
    PHONE_NUMBER VARCHAR(255) NOT NULL,
    NAME VARCHAR(255) NOT NULL,
    EMAIL VARCHAR(255) UNIQUE,
    ADDRESS TEXT,
    HOME_GEOFENCE_ID VARCHAR(255), -- Changed to VARCHAR
    ADDRESS_LONGITUDE VARCHAR(50), -- New field
    ADDRESS_LATITUDE VARCHAR(50)
);

CREATE TABLE IF NOT EXISTS DL_AGENT (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL,
    STATE VARCHAR(50) NOT NULL, -- Storing enum as VARCHAR
    TEAM_ID BIGINT,
    PHONE_NUMBER VARCHAR(20) NOT NULL UNIQUE,
    UNIQUE_ID VARCHAR(255) NOT NULL UNIQUE,
    JOINING_DATE DATE NOT NULL,
    TERMINATION_DATE DATE,
    DESIGNATION VARCHAR(50) NOT NULL,
    FOREIGN KEY (TEAM_ID) REFERENCES DL_TEAM(ID)
);

-- New table for CatalogEntity
CREATE TABLE IF NOT EXISTS DL_CATALOG (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TYPE VARCHAR(50) NOT NULL, -- Stores enum as VARCHAR
    NAME VARCHAR(255) NOT NULL,
    UNIT VARCHAR(50) NOT NULL, -- Stores enum as VARCHAR
    UNIT_PRICE DECIMAL(10, 2) NOT NULL
);

CREATE TABLE IF NOT EXISTS DL_GEOFENCE (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    STORE_ID BIGINT NOT NULL,
    POLYGON_COORDINATES TEXT NOT NULL, -- Updated column name
    GEOFENCE_TYPE VARCHAR(50) NOT NULL, -- Updated column name
    NAME VARCHAR(255) NOT NULL,
    ACTIVE BOOLEAN NOT NULL
);

-- Table for InvoiceEntity
CREATE TABLE IF NOT EXISTS DL_INVOICE (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SWIPE_INVOICE_ID VARCHAR(255) UNIQUE,
    CUSTOMER_ID BIGINT NOT NULL,
    INVOICE_DATE TIMESTAMP NOT NULL,
    TOTAL_PRICE DECIMAL(10, 2) NOT NULL,
    TOTAL_TAX DECIMAL(10, 2),
    TOTAL_DISCOUNT DECIMAL(10, 2),
    FOREIGN KEY (CUSTOMER_ID) REFERENCES DL_CUSTOMER(ID)
);

-- Table for InvoiceItemEntity
CREATE TABLE IF NOT EXISTS DL_INVOICE_ITEM (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    INVOICE_ID BIGINT NOT NULL,
    CATALOG_ID BIGINT NOT NULL,
    QUANTITY INTEGER NOT NULL,
    ITEM_PRICE DECIMAL(10, 2) NOT NULL,
    TAX DECIMAL(10, 2) NOT NULL,
    -- Uncomment below if you want cascade delete
    FOREIGN KEY (CATALOG_ID) REFERENCES DL_CATALOG(ID),
    FOREIGN KEY (INVOICE_ID) REFERENCES DL_INVOICE(ID) ON DELETE CASCADE
);



-- Updated table for OrderEntity
CREATE TABLE IF NOT EXISTS DL_ORDER (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    STORE_ID BIGINT,
    CUSTOMER_ID BIGINT NOT NULL,
    ORDER_DATE TIMESTAMP NOT NULL,
    STATUS VARCHAR(50) NOT NULL,
    TOTAL_AMOUNT DECIMAL(10, 2) NOT NULL,
    FOREIGN KEY (CUSTOMER_ID) REFERENCES DL_CUSTOMER(ID),
    FOREIGN KEY (STORE_ID) REFERENCES DL_STORE(ID)
);

-- Tables for OrderItemEntity and OrderItemMetadataEntity (unchanged from previous)
CREATE TABLE IF NOT EXISTS DL_ORDER_ITEM (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ORDER_ID BIGINT NOT NULL,
    CATALOG_ID BIGINT NOT NULL,
    QUANTITY DECIMAL(10, 2),
    ITEM_PRICE_AT_ORDER DECIMAL(10, 2) NOT NULL,
    NOTES TEXT,
    FOREIGN KEY (ORDER_ID) REFERENCES DL_ORDER(ID) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS DL_ORDER_ITEM_METADATA (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ORDER_ITEM_ID BIGINT NOT NULL,
    TYPE VARCHAR(255) NOT NULL,
    ITEM_VALUE TEXT,
    DESCRIPTION TEXT,
    FOREIGN KEY (ORDER_ITEM_ID) REFERENCES DL_ORDER_ITEM(ID) ON DELETE CASCADE
);

-- New table for TaskEntity
CREATE TABLE IF NOT EXISTS DL_TASK (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL,
    DESCRIPTION TEXT,
    TYPE VARCHAR(50) NOT NULL,
    TASK_START_TIME TIMESTAMP,
    TASK_UPDATED_TIME TIMESTAMP,
    TASK_COMPLETED_TIME TIMESTAMP,
    STATUS VARCHAR(50) NOT NULL,
    TEAM_ID BIGINT,
    AGENT_ID BIGINT,
    SOURCE_ADDRESS VARCHAR(255) NOT NULL,
    SOURCE_GEOFENCE_ID BIGINT,
    DESTINATION_ADDRESS VARCHAR(255) NOT NULL,
    DESTINATION_GEOFENCE_ID BIGINT,
    TASK_COMMENT TEXT,
    ORDER_ID BIGINT NOT NULL,
    FOREIGN KEY (TEAM_ID) REFERENCES DL_TEAM(ID),
    FOREIGN KEY (AGENT_ID) REFERENCES DL_AGENT(ID),
    FOREIGN KEY (ORDER_ID) REFERENCES DL_ORDER(ID)
);