--/**
-- * @author Somendra Datta <sodatta@gmail.com>
-- * @version 12/07/25
-- */


-- New table for GeofenceEntity

CREATE TABLE IF NOT EXISTS DL_GEOFENCE (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    POLYGON_COORDINATES TEXT NOT NULL, -- Updated column name
    GEOFENCE_TYPE VARCHAR(50) NOT NULL, -- Updated column name
    NAME VARCHAR(255) NOT NULL,
    ACTIVE BOOLEAN NOT NULL
);

-- New table for TeamEntity
CREATE TABLE IF NOT EXISTS DL_TEAM (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL UNIQUE,
    DESCRIPTION TEXT,
    ROLE VARCHAR(50) NOT NULL
);

-- New table for StoreEntity
CREATE TABLE IF NOT EXISTS DL_STORE (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL,
    ADDRESS VARCHAR(255),
    CONTACT_NUMBER VARCHAR(20),
    EMAIL VARCHAR(255),
    MANAGER_ID BIGINT
);


-- New table for ManagerEntity
CREATE TABLE IF NOT EXISTS DL_MANAGER (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL,
    CONTACT VARCHAR(255) NOT NULL
);

-- New table for CustomerEntity
CREATE TABLE IF NOT EXISTS DL_CUSTOMER (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SUBSCRIBER_ID VARCHAR(255),
    PHONE_NUMBER VARCHAR(255) NOT NULL,
    NAME VARCHAR(255) NOT NULL,
    EMAIL VARCHAR(255),
    ADDRESS TEXT,
    HOME_GEOFENCE_ID VARCHAR(255), -- Changed to VARCHAR
    ADDRESS_LONGITUDE VARCHAR(50), -- New field
    ADDRESS_LATITUDE VARCHAR(50)
);

CREATE TABLE IF NOT EXISTS DL_CUSTOMER_ADDRESS (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CUSTOMER_ID BIGINT NOT NULL,
    ADDRESS_TYPE VARCHAR(50) NOT NULL,
    IS_DEFAULT BOOLEAN NOT NULL,
    FLAT_APARTMENT VARCHAR(255),
    ADDRESS_LINE VARCHAR(255) NOT NULL,
    STREET VARCHAR(255),
    CITY VARCHAR(100),
    STATE VARCHAR(100),
    ZIP_CODE VARCHAR(20),
    COUNTRY VARCHAR(100),
    LONGITUDE VARCHAR(50),
    LATITUDE VARCHAR(50),
    GEOFENCE_ID BIGINT,
    FOREIGN KEY (CUSTOMER_ID) REFERENCES DL_CUSTOMER(ID),
    FOREIGN KEY (GEOFENCE_ID) REFERENCES DL_GEOFENCE(ID)
);


-- Agent Module##################################################
CREATE TABLE IF NOT EXISTS DL_AGENT (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL,
    STATE VARCHAR(50) NOT NULL, -- Storing enum as VARCHAR
    TEAM_ID BIGINT,
    PHONE_NUMBER VARCHAR(20) NOT NULL UNIQUE,
    UNIQUE_ID VARCHAR(255) NOT NULL UNIQUE,
    JOINING_DATE DATE NOT NULL,
    TERMINATION_DATE DATE,
    DESIGNATION VARCHAR(50) NOT NULL,
    FOREIGN KEY (TEAM_ID) REFERENCES DL_TEAM(ID)
);
-- Agent Module##################################################

-- New table for CatalogEntity
CREATE TABLE IF NOT EXISTS DL_CATALOG (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TYPE VARCHAR(50) NOT NULL, -- Stores enum as VARCHAR
    NAME VARCHAR(255) NOT NULL,
    UNIT VARCHAR(50) NOT NULL, -- Stores enum as VARCHAR
    UNIT_PRICE DECIMAL(10, 2) NOT NULL
);

-- Table for InvoiceEntity
CREATE TABLE IF NOT EXISTS DL_INVOICE (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SWIPE_INVOICE_ID VARCHAR(255) UNIQUE,
    CUSTOMER_ID BIGINT NOT NULL,
    INVOICE_DATE TIMESTAMP NOT NULL,
    TOTAL_PRICE DECIMAL(10, 2) NOT NULL,
    TOTAL_TAX DECIMAL(10, 2),
    TOTAL_DISCOUNT DECIMAL(10, 2),
    FOREIGN KEY (CUSTOMER_ID) REFERENCES DL_CUSTOMER(ID)
);

-- Table for InvoiceItemEntity
CREATE TABLE IF NOT EXISTS DL_INVOICE_ITEM (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    INVOICE_ID BIGINT NOT NULL,
    CATALOG_ID BIGINT NOT NULL,
    QUANTITY INTEGER NOT NULL,
    ITEM_PRICE DECIMAL(10, 2) NOT NULL,
    TAX DECIMAL(10, 2) NOT NULL,
    -- Uncomment below if you want cascade delete
    FOREIGN KEY (CATALOG_ID) REFERENCES DL_CATALOG(ID),
    FOREIGN KEY (INVOICE_ID) REFERENCES DL_INVOICE(ID) ON DELETE CASCADE
);



-- Updated table for OrderEntity
CREATE TABLE IF NOT EXISTS DL_ORDER (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    STORE_ID BIGINT,
    CUSTOMER_ID BIGINT NOT NULL,
    ORDER_DATE TIMESTAMP NOT NULL,
    STATUS VARCHAR(50) NOT NULL,
    TOTAL_AMOUNT DECIMAL(10, 2) NOT NULL,
--    ORDER_ADDRESS_ID BIGINT NOT NULL,
    FOREIGN KEY (CUSTOMER_ID) REFERENCES DL_CUSTOMER(ID),
    FOREIGN KEY (STORE_ID) REFERENCES DL_STORE(ID)
);

-- Tables for OrderItemEntity and OrderItemMetadataEntity (unchanged from previous)
CREATE TABLE IF NOT EXISTS DL_ORDER_ITEM (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ORDER_ID BIGINT NOT NULL,
    CATALOG_ID BIGINT NOT NULL,
    QUANTITY DECIMAL(10, 2),
    ITEM_PRICE_AT_ORDER DECIMAL(10, 2) NOT NULL,
    NOTES TEXT,
    FOREIGN KEY (ORDER_ID) REFERENCES DL_ORDER(ID) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS DL_ORDER_ITEM_METADATA (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ORDER_ITEM_ID BIGINT NOT NULL,
    TYPE VARCHAR(255) NOT NULL,
    ITEM_VALUE TEXT,
    DESCRIPTION TEXT,
    FOREIGN KEY (ORDER_ITEM_ID) REFERENCES DL_ORDER_ITEM(ID) ON DELETE CASCADE
);

-- New table for TaskEntity
CREATE TABLE IF NOT EXISTS DL_TASK (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR(255) NOT NULL,
    DESCRIPTION TEXT,
    TYPE VARCHAR(50) NOT NULL,
    TASK_START_TIME TIMESTAMP,
    TASK_UPDATED_TIME TIMESTAMP,
    TASK_COMPLETED_TIME TIMESTAMP,
    STATUS VARCHAR(50) NOT NULL,
    TEAM_ID BIGINT,
    AGENT_ID BIGINT,
    SOURCE_ADDRESS VARCHAR(255) NOT NULL,
    SOURCE_GEOFENCE_ID BIGINT,
    DESTINATION_ADDRESS VARCHAR(255) NOT NULL,
    DESTINATION_GEOFENCE_ID BIGINT,
    TASK_COMMENT TEXT,
    ORDER_ID BIGINT NOT NULL,
    FOREIGN KEY (TEAM_ID) REFERENCES DL_TEAM(ID),
    FOREIGN KEY (AGENT_ID) REFERENCES DL_AGENT(ID),
    FOREIGN KEY (ORDER_ID) REFERENCES DL_ORDER(ID)
);


-- Support Entities
--Agent Module #############
CREATE TABLE IF NOT EXISTS DL_AGENT_TEAM_SUMMARY (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    AGENT_ID BIGINT NOT NULL,
    TEAM_ID BIGINT NOT NULL,
    TEAM_NAME VARCHAR(255) NOT NULL,
    TEAM_DESCRIPTION TEXT,
    FOREIGN KEY (AGENT_ID) REFERENCES DL_AGENT(ID),
    FOREIGN KEY (TEAM_ID) REFERENCES DL_TEAM(ID)
);

CREATE TABLE IF NOT EXISTS DL_AGENT_TASK_SUMMARY (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TASK_ID BIGINT NOT NULL,
    AGENT_ID BIGINT NOT NULL,
    TASK_NAME VARCHAR(255) NOT NULL,
    TASK_TYPE VARCHAR(50) NOT NULL,
    TASK_STATUS VARCHAR(50) NOT NULL,
    TASK_START_TIME TIMESTAMP,
    SOURCE_ADDRESS VARCHAR(255),
    DESTINATION_ADDRESS VARCHAR(255),
    ORDER_ID BIGINT,
    FOREIGN KEY (AGENT_ID) REFERENCES DL_AGENT(ID),
    FOREIGN KEY (TASK_ID) REFERENCES DL_TASK(ID),
    FOREIGN KEY (ORDER_ID) REFERENCES DL_ORDER(ID)
);

-- Store Module ########
CREATE TABLE IF NOT EXISTS DL_STORE_CATALOG (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    STORE_ID BIGINT NOT NULL,
    CATALOG_ID BIGINT NOT NULL,
    UNIQUE (STORE_ID, CATALOG_ID),
    FOREIGN KEY (STORE_ID) REFERENCES DL_STORE(ID),
    FOREIGN KEY (CATALOG_ID) REFERENCES DL_CATALOG(ID)
);

-- Customer Module #########
CREATE TABLE IF NOT EXISTS DL_CUSTOMER_ORDER_SUMMARY (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ORDER_ID BIGINT NOT NULL UNIQUE, -- The ID from the DL_ORDER table. Unique as each order has one summary.
    CUSTOMER_ID BIGINT NOT NULL, -- The ID from the DL_CUSTOMER table
    ORDER_DATE TIMESTAMP,
    STATUS VARCHAR(50),
    TOTAL_AMOUNT DECIMAL(10, 2),
    STORE_ID BIGINT,
    FOREIGN KEY (ORDER_ID) REFERENCES DL_ORDER(ID),
    FOREIGN KEY (CUSTOMER_ID) REFERENCES DL_CUSTOMER(ID),
    FOREIGN KEY (STORE_ID) REFERENCES DL_STORE(ID)
);

-- Geofence Module ########
CREATE TABLE IF NOT EXISTS DL_GEOFENCE_ORDER_SUMMARY (
    ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ORDER_ID BIGINT NOT NULL UNIQUE, -- The ID from the DL_ORDER table. Unique as each order has one summary.
    GEOFENCE_ID BIGINT NOT NULL, -- The ID from the DL_GEOFENCE table
    ORDER_DATE TIMESTAMP,
    STATUS VARCHAR(50),
    TOTAL_AMOUNT DECIMAL(10, 2),
    CUSTOMER_ID BIGINT,
    STORE_ID BIGINT,
    FOREIGN KEY (ORDER_ID) REFERENCES DL_ORDER(ID),
    FOREIGN KEY (GEOFENCE_ID) REFERENCES DL_GEOFENCE(ID),
    FOREIGN KEY (CUSTOMER_ID) REFERENCES DL_CUSTOMER(ID),
    FOREIGN KEY (STORE_ID) REFERENCES DL_STORE(ID)
);